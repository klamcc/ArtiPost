<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CraftVietnam - Your Marketplace</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for general text -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FBFAF9; /* Consistent background */
            overflow-x: hidden;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column; /* Allow content to push footer down */
        }
        /* Reusing gradient text for consistency */
        .gradient-text {
            background: linear-gradient(to right, #FFD700, #FF8C00, #F18258);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }
        /* Navbar styles */
        .main-navbar {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1-px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
            transform: translateZ(0); /* Ensures fixed header stays on top */
            -webkit-transform: translateZ(0);
        }
        .main-navbar .nav-link,
        .main-navbar .icon-btn,
        .main-navbar .logo-text,
        .main-navbar .user-info {
            color: #2d3748; /* Darker text for links/icons */
        }
        .main-navbar .sign-out-btn {
            background-color: #f0f2f5; /* Light gray for sign out button */
            color: #2d3748; /* Dark text */
            border: 1px solid #e2e8f0; /* Light border */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .main-navbar .sign-out-btn:hover {
            background-color: #e2e8f0;
        }
        /* Product card styling */
        .product-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid #E7DFDA;
            overflow: hidden; /* Corrected CSS syntax */
            transition: box-shadow 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Default shadow */
            pointer-events: auto; /* Re-enabled pointer events */
        }
        .product-card:hover {
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.08);
            transform: translateY(-5px);
        }
        /* Footer gradient text */
        .footer-gradient-text {
            background: linear-gradient(to right, #FFD700, #FF8C00, #F18258); /* Gold to Dark Orange to Salmon */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback for browsers that don't support -webkit-text-fill-color */
        }
        /* Custom grey color for text */
        .text-custom-grey-landing {
            color: #8C7B73;
        }
        /* Styles for search and filter section - Adjusted colors */
        .search-filter-section {
            background-color: #F8F7F5; /* Light background from the image */
            border-bottom: 1px solid #E7DFDA; /* Lighter border */
            padding: 1rem 0;
            box-shadow: none; /* Removed shadow as per image */
        }
        .search-input {
            border: 1px solid #E7DFDA;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem 0.75rem 2.5rem; /* Left padding for icon */
            width: 100%;
            font-size: 0.9rem;
            color: #4a5568;
            background-color: #ffffff; /* White background for input */
            outline: none;
        }
        .search-input:focus {
            border-color: #d1c4b8; /* Slightly darker shade of #E7DFDA for focus */
            box-shadow: 0 0 0 3px rgba(231, 223, 218, 0.5); /* Glow using #E7DFDA */
        }

        /* Custom Dropdown Styles */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
            cursor: pointer;
            user-select: none;
        }

        .selected-value {
            border: 1px solid #E7DFDA;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            color: #4a5568;
            background-color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .selected-value:focus,
        .selected-value:active {
            border-color: #d1c4b8;
            box-shadow: 0 0 0 3px rgba(231, 223, 218, 0.5);
        }

        .dropdown-options {
            position: absolute;
            top: calc(100% + 8px); /* Position below the selected value with some gap */
            left: 0;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #E7DFDA;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px; /* Limit height for scrollability */
            overflow-y: auto;
            z-index: 500; /* Ensure it's above other content but below cart */
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out, visibility 0.2s ease-out;
        }

        .dropdown-options.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-option {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            color: #4a5568;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s ease-in-out;
        }

        .dropdown-option:hover {
            background-color: #F6E6DF; /* Light orange/cream hover */
        }

        .dropdown-option.selected {
            background-color: #F6E6DF; /* Light orange/cream for selected */
            font-weight: 500;
        }

        .dropdown-option .checkmark {
            color: #f97316; /* Orange color for checkmark */
            margin-left: 0.5rem;
        }

        .product-tag {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            z-index: 10;
        }
        .product-tag.new {
            background-color: #22c55e; /* Green-500 */
        }
        .product-tag.featured {
            background-color: #f97316; /* Orange-500 */
        }

        /* Cart Sidebar Styles */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 450px; /* Made wider */
            height: 100%;
            background-color: #FBFAF9; /* Match body background */
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            transform: translateX(100%); /* Initially hidden off-screen */
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #E7DFDA; /* Border to match other elements */
        }

        .cart-sidebar.open {
            transform: translateX(0); /* Slide in */
        }

        .cart-header {
            background-color: #ffffff;
            padding: 1.5rem;
            border-bottom: 1px solid #E7DFDA;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #8C7B73;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }

        .cart-close-btn:hover {
            color: #f97316;
        }

        .empty-cart-message {
            text-align: center;
            padding: 2rem;
            color: #8C7B73;
            flex-grow: 1; /* Allows it to take up available space */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .empty-cart-icon {
            font-size: 4rem; /* Large icon */
            color: #E7DFDA; /* Light grey color */
            margin-bottom: 1rem;
        }

        .cart-items-container {
            flex-grow: 1; /* Take up available space */
            padding: 1.5rem;
            overflow-y: auto; /* Enable scrolling for many items */
        }

        /* Cart Item Specific Styles */
        .cart-item {
            display: flex;
            align-items: center;
            background-color: #ffffff; /* White background for each item */
            border: 1px solid #E7DFDA; /* Border for each item */
            border-radius: 0.75rem; /* Rounded corners for each item */
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow */
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-right: 1rem;
            border: 1px solid #E7DFDA;
            flex-shrink: 0; /* Prevent image from shrinking */
        }

        .cart-item-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .cart-item-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .cart-item-artisan {
            font-size: 0.8rem;
            color: #8C7B73;
            margin-bottom: 0.5rem;
        }

        .cart-item-price {
            font-size: 1rem;
            color: #f97316;
            font-weight: 600;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            margin-left: 1rem;
            flex-shrink: 0; /* Prevent actions from shrinking */
        }

        .quantity-btn {
            background-color: #F6E6DF; /* Light orange/cream */
            color: #f97316; /* Orange text */
            border: 1px solid #E7DFDA;
            border-radius: 0.375rem; /* Slightly rounded */
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .quantity-btn:hover {
            background-color: #f97316; /* Orange background on hover */
            color: white; /* White text on hover */
        }

        .item-quantity {
            font-size: 1rem;
            font-weight: 500;
            color: #2d3748;
            margin: 0 0.5rem;
            min-width: 20px;
            text-align: center;
        }

        .cart-item-remove {
            background: none;
            border: none;
            color: #EF4444; /* Red-500 */
            cursor: pointer;
            font-size: 1.2rem; /* Slightly larger icon */
            margin-left: 0.75rem;
            transition: color 0.2s ease-in-out;
        }

        .cart-item-remove:hover {
            color: #DC2626; /* Red-600 */
        }

        .cart-footer {
            background-color: #ffffff;
            padding: 1.5rem;
            border-top: 1px solid #E7DFDA;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3748;
        }

        .checkout-button {
            background: linear-gradient(to right, #FFD700, #FF8C00, #F18258); /* Gradient button */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            width: 100%;
            transition: background 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .checkout-button:hover {
            background: linear-gradient(to right, #F18258, #FF8C00, #FFD700); /* Reverse gradient on hover */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        /* Overlay for background fade */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0); /* Start transparent */
            z-index: 999; /* Below cart, above everything else */
            pointer-events: none; /* Allow clicks to pass through when hidden/transparent */
            transition: background-color 0.1s ease-in-out; /* Faster fade */
        }

        .overlay.active {
            pointer-events: auto; /* Block clicks when active */
        }

        /* Message Box Styles */
        #message-box {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; /* Changed to flex to center content */
            align-items: center;
            justify-content: center;
            z-index: 1001; /* Ensure it's on top */
            visibility: hidden; /* Hidden by default */
            opacity: 0; /* Fade in/out */
            transition: visibility 0s, opacity 0.3s ease-in-out;
        }
        #message-box.visible {
            visibility: visible;
            opacity: 1;
        }
        #message-box > div {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 24rem;
            width: 90%;
            text-align: center;
        }

        /* Address/Phone Modal Styles */
        #address-phone-modal, #my-orders-modal { /* Apply common styles to both modals */
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay for this modal */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002; /* Higher z-index than message-box */
            visibility: hidden; /* Hidden by default */
            opacity: 0; /* Fade in/out */
            transition: visibility 0s, opacity 0.3s ease-in-out;
        }
        #address-phone-modal.visible, #my-orders-modal.visible {
            visibility: visible;
            opacity: 1;
        }
        #address-phone-modal > div, #my-orders-modal > div {
            background-color: #FBFAF9; /* Match body background */
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            max-width: 700px; /* Wider modal */
            width: 90%;
            text-align: left;
            border: 1px solid #E7DFDA;
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Spacing between sections */
        }
        #address-phone-modal .input-field, #my-orders-modal .input-field {
            border: 1px solid #E7DFDA;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            color: #4a5568;
            outline: none;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        #address-phone-modal .input-field:focus, #my-orders-modal .input-field:focus {
            border-color: #d1c4b8;
            box-shadow: 0 0 0 3px rgba(231, 223, 218, 0.5);
        }
        #address-phone-modal .radio-option, #my-orders-modal .radio-option {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border: 1px solid #E7DFDA;
            border-radius: 0.375rem;
            background-color: #ffffff;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            margin-bottom: 0.5rem; /* Space between options */
            position: relative; /* For positioning delete button */
        }
        #address-phone-modal .radio-option:last-child, #my-orders-modal .radio-option:last-child {
            margin-bottom: 0; /* No margin for the last one */
        }
        #address-phone-modal .radio-option:hover, #my-orders-modal .radio-option:hover {
            background-color: #F6E6DF;
            border-color: #f97316;
        }
        #address-phone-modal .radio-option.selected, #my-orders-modal .radio-option.selected {
            background-color: #F6E6DF; /* Highlight selected */
            border-color: #f97316;
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.3);
        }
        #address-phone-modal .radio-option input[type="radio"], #my-orders-modal .radio-option input[type="radio"] {
            margin-right: 0.75rem;
            accent-color: #f97316; /* Orange radio button */
        }
        #address-phone-modal .list-container, #my-orders-modal .list-container {
            /* Removed max-height and overflow-y: auto to prevent scrollbars */
            border: 1px solid #E7DFDA;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background-color: #fdfcfb; /* Slightly off-white for list background */
        }
        #address-phone-modal .list-container p.text-gray-500, #my-orders-modal .list-container p.text-gray-500 {
            padding: 0.5rem;
        }
        .add-btn-icon {
            background-color: #f97316; /* Orange background */
            color: white;
            padding: 0.5rem; /* Adjust padding to make it a square */
            border-radius: 0.375rem; /* Slightly rounded corners */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            width: 38px; /* Set a fixed width to ensure square shape */
            height: 38px; /* Set a fixed height to ensure square shape */
        }
        .add-btn-icon:hover {
            background-color: #e26214; /* Darker orange on hover */
        }
        .delete-item-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #EF4444; /* Red-500 */
            cursor: pointer;
            font-size: 1rem;
            padding: 0.25rem;
            border-radius: 50%;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .delete-item-btn:hover {
            background-color: #FEE2E2; /* Light red background on hover */
            color: #DC2626; /* Darker red on hover */
        }

        /* Autocomplete specific styles */
        #autocomplete-results {
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: calc(100% - 2rem); /* Match input width, accounting for padding */
            background-color: white;
            border: 1px solid #E7DFDA;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 20;
            left: 1rem;
            right: 1rem;
            top: calc(100% + 0.5rem); /* Position below the input field */
        }
        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item:hover {
            background-color: #f6f6f6;
        }

        /* Order Item Specific Styles */
        .order-card {
            background-color: #ffffff;
            border: 1px solid #E7DFDA;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer; /* Indicate it's clickable for expansion */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .order-card:hover {
            background-color: #F8F7F5;
            border-color: #d1c4b8;
        }
        .order-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #2d3748;
        }
        .order-details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .order-details-container.open {
            max-height: 500px; /* Arbitrary large enough value for expansion */
        }
        .order-item-detail {
            display: flex;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed #E7DFDA;
        }
        .order-item-detail:first-of-type {
            border-top: none;
            padding-top: 0;
        }
        .order-item-detail img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.375rem;
            margin-right: 0.75rem;
            border: 1px solid #E7DFDA;
        }
        .order-item-info {
            flex-grow: 1;
        }
        .order-item-info div {
            font-size: 0.9rem;
            color: #4a5568;
        }
        .order-item-info .item-name {
            font-weight: 500;
        }
        .order-item-info .item-price {
            color: #f97316;
            font-weight: 600;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            text-transform: capitalize;
        }
        .status-pending { background-color: #f97316; } /* Orange */
        .status-completed { background-color: #22c55e; } /* Green */
        .status-cancelled { background-color: #ef4444; } /* Red */
        .status-shipped { background-color: #3b82f6; } /* Blue */

    </style>
</head>
<body>
    <!-- Header Section - Navbar for logged-in user -->
    <header class="main-navbar fixed top-0 left-0 right-0 z-50 py-3 px-6 md:px-10 flex items-center justify-between">
        <div class="flex items-center space-x-8">
            <div class="text-lg font-bold logo-text">CraftVietnam</div>
            <nav class="flex flex-col sm:flex-row space-y-1 sm:space-y-0 sm:space-x-5 text-sm">
                <a href="#" class="nav-link hover:text-orange-600">Shop</a>
                <a href="#" class="nav-link hover:text-orange-600">Artisans</a>
                <a href="#" class="nav-link hover:text-orange-600">Categories</a>
            </nav>
        </div>
        <div class="flex items-center space-x-3">
            <button class="icon-btn hover:text-orange-600 p-1.5 rounded-full hover:bg-gray-100">
                <i class="fas fa-heart"></i>
            </button>
            <button class="icon-btn hover:text-orange-600 p-1.5 rounded-full hover:bg-gray-100 relative" id="cart-icon-btn">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-item-count" class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
            <button class="icon-btn hover:text-orange-600 p-1.5 rounded-full hover:bg-gray-100" id="my-orders-btn">
                <i class="fas fa-box-open"></i> <!-- Icon for orders -->
            </button>
            <button class="icon-btn hover:text-orange-600 p-1.5 rounded-full hover:bg-gray-100" id="user-profile-btn">
                <i class="fas fa-user"></i>
            </button>
            <!-- Logout button, hidden by default, shown when user profile is clicked -->
            <button id="logout-btn" class="sign-out-btn px-4 py-2 rounded-full shadow-sm text-sm hidden">Sign Out</button>
        </div>
    </header>

    <!-- Search and Filter Section -->
    <section class="search-filter-section pt-24 pb-4">
        <div class="container mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="relative w-full md:w-1/3">
                <input type="text" id="search-input" placeholder="Search for handcrafted items..." class="search-input">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 w-full md:w-2/3 justify-end">
                <!-- Custom Category Dropdown -->
                <div class="custom-dropdown-container w-full sm:w-auto" id="category-dropdown">
                    <div class="selected-value">
                        <span data-value="">All Categories</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-option selected" data-value="">All Categories <i class="fas fa-check checkmark"></i></div>
                        <div class="dropdown-option" data-value="Lacquerware">Lacquerware</div>
                        <div class="dropdown-option" data-value="Pottery & Ceramics">Pottery & Ceramics</div>
                        <div class="dropdown-option" data-value="Traditional Paintings">Traditional Paintings</div>
                        <div class="dropdown-option" data-value="Handwoven Textiles">Handwoven Textiles</div>
                    </div>
                </div>

                <!-- Custom Price Dropdown -->
                <div class="custom-dropdown-container w-full sm:w-auto" id="price-dropdown">
                    <div class="selected-value">
                        <span data-value="">All Prices</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-option selected" data-value="">All Prices <i class="fas fa-check checkmark"></i></div>
                        <div class="dropdown-option" data-value="0-50">$0 - $50</div>
                        <div class="dropdown-option" data-value="51-100">$51 - $100</div>
                        <div class="dropdown-option" data-value="101+">$101+</div>
                    </div>
                </div>

                <!-- Custom Sort By Dropdown -->
                <div class="custom-dropdown-container w-full sm:w-auto" id="sort-dropdown">
                    <div class="selected-value">
                        <span data-value="featured">Featured</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-option selected" data-value="featured">Featured <i class="fas fa-check checkmark"></i></div>
                        <div class="dropdown-option" data-value="new-arrivals">New Arrivals</div>
                        <div class="dropdown-option" data-value="best-sellers">Best Sellers</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content Area -->
    <main class="flex-grow pb-12">
        <!-- Featured Products Section -->
        <section class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900">Featured Products</h2>
                <span class="text-gray-600 text-sm" id="product-count">0 products found</span>
            </div>
            <!-- Moved no-items-message outside products-container -->
            <p id="no-items-message" class="col-span-full text-center text-gray-500 hidden mb-4">No items found.</p>
            <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Products will be loaded here dynamically from Firestore -->
            </div>
        </section>
    </main>

    <!-- Overlay for background fade -->
    <div id="overlay" class="overlay"></div>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="cart-sidebar">
        <div class="cart-header">
            <h2 class="text-xl font-semibold text-gray-900">Shopping Cart (<span id="cart-header-item-count">0</span> items)</h2>
            <button id="cart-close-btn" class="cart-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Moved empty-cart-message outside cart-items-container -->
        <div id="empty-cart-message" class="empty-cart-message">
            <i class="fas fa-shopping-bag empty-cart-icon"></i>
            <p class="text-lg font-medium">Your cart is empty</p>
            <p class="text-sm">Add some beautiful crafts to get started!</p>
        </div >
        <div id="cart-items-container" class="cart-items-container">
            <!-- Cart items will be rendered here -->
        </div>
        <div id="cart-footer" class="cart-footer hidden">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cart-total-price">$0.00</span>
            </div>
            <button id="checkout-button" class="checkout-button">Proceed to Checkout</button>
        </div>
    </div>

    <!-- Message Box HTML -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1001] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="message-box-text" class="text-lg font-semibold mb-4"></p>
            <button id="message-box-close" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition-colors">OK</button>
        </div>
    </div>

    <!-- Address and Phone Number Selection Modal -->
    <div id="address-phone-modal" class="hidden">
        <div>
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Confirm Shipping Details & Payment</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Address Selection -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Select Address:</h4>
                    <div id="address-list" class="list-container space-y-2 mb-4">
                        <!-- Addresses will be loaded here -->
                        <p class="text-gray-500 text-sm text-center py-2">No addresses found. Add one below.</p>
                    </div>
                    <div class="flex items-center space-x-2 relative">
                        <input type="text" id="new-address-input" placeholder="Add new address" class="input-field flex-grow">
                        <button id="add-address-btn" class="add-btn-icon">
                            <i class="fas fa-plus"></i>
                        </button>
                        <div id="autocomplete-results" class="hidden"></div>
                    </div>
                </div>

                <!-- Phone Number Selection -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Select Phone Number:</h4>
                    <div id="phone-list" class="list-container space-y-2 mb-4">
                        <!-- Phone numbers will be loaded here -->
                        <p class="text-gray-500 text-sm text-center py-2">No phone numbers found. Add one below.</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="tel" id="new-phone-input" placeholder="Add new phone number" class="input-field flex-grow">
                        <button id="add-phone-btn" class="add-btn-icon">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Payment Method Selection -->
            <div class="mt-6">
                <h4 class="font-medium text-gray-700 mb-2">Select Payment Method:</h4>
                <div id="payment-method-list" class="list-container space-y-2">
                    <label class="radio-option">
                        <input type="radio" name="paymentMethod" value="Credit Card">
                        <span><i class="fas fa-credit-card mr-2"></i>Credit Card</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="paymentMethod" value="PayPal">
                        <span><i class="fab fa-paypal mr-2"></i>PayPal</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="paymentMethod" value="Cash on Delivery">
                        <span><i class="fas fa-money-bill-wave mr-2"></i>Cash on Delivery (COD)</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-address-phone-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">Cancel</button>
                <button id="confirm-order-btn" class="checkout-button px-4 py-2 rounded-md" disabled>Confirm Order</button>
            </div>
        </div>
    </div>

    <!-- My Orders Modal -->
    <div id="my-orders-modal" class="hidden">
        <div>
            <h3 class="text-xl font-semibold mb-4 text-gray-800">My Orders</h3>
            <div id="orders-list" class="list-container space-y-4 max-h-[60vh] overflow-y-auto">
                <!-- Orders will be loaded here -->
                <p class="text-gray-500 text-sm text-center py-2">No orders found.</p>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-my-orders-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">Close</button>
            </div>
        </div>
    </div>


    <!-- Footer Section -->
    <footer class="bg-[#171312] text-white py-12 px-6 md:px-10 mt-auto">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-4 gap-8">
            <div>
                <h3 class="text-lg font-bold mb-4 footer-gradient-text">CraftVietnam</h3>
                <p class="text-gray-400 text-sm mb-6">
                    Connecting Vietnamese artisans with the world. Authentic traditional crafts, safely shipped to your doorstep.
                </p>
                <div class="flex space-x-4 text-gray-400">
                    <a href="#" class="hover:text-white"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="hover:text-white"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="hover:text-white"><i class="fab fa-twitter"></i></a>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-bold mb-4">Shop</h3>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="text-gray-400 hover:text-white">Lacquerware</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Pottery</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Paintings</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">All Categories</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Featured Artisans</a></li>
                </ul>
            </div>

            <div>
                <h3 class="text-lg font-bold mb-4">Support</h3>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="text-gray-400 hover:text-white">Help Center</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Shipping Info</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Returns</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Size Guide</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Contact Us</a></li>
                </ul>
            </div>

            <div>
                <h3 class="text-lg font-bold mb-4">Contact</h3>
                <ul class="space-y-2 text-sm">
                    <li class="flex items-center space-x-2 text-gray-400">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Ho Chi Minh City, Vietnam</span>
                    </li>
                    <li class="flex items-center space-x-2 text-gray-400">
                        <i class="fas fa-envelope"></i>
                        <a href="mailto:hello@craftvietnam.com" class="hover:text-white">hello@craftvietnam.com</a>
                    </li>
                    <li class="flex items-center space-x-2 text-gray-400">
                        <i class="fas fa-phone"></i>
                        <span>+84 123 456 789</span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="container mx-auto text-center text-gray-500 text-xs mt-8 border-t border-gray-700 pt-6">
            <p>&copy; 2024 CraftVietnam. All rights reserved.</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="hover:text-white">Privacy Policy</a>
                <a href="#" class="hover:text-white">Terms of Service</a>
                <a href="#" class="hover:text-white">Cookie Policy</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, addDoc, updateDoc, arrayUnion, arrayRemove, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyD1wat0lrESovvsgy2x5Kf4M4jQsR2KHHs",
            authDomain: "ffb-hackathon.firebaseapp.com",
            projectId: "ffb-hackathon",
            storageBucket: "ffb-hackathon.firebasestorage.app",
            messagingSenderId: "411311658832",
            appId: "1:411311658832:web:7916ad56ce15f43d263e55",
            measurementId: "G-XMB5N1R5PG"
        };

        // Geoapify API Key (provided by user)
        const GEOAPIFY_API_KEY = "3f2b658afc7b4b0a8f4a1bba19d7f7d9";

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let cart = []; // Array to hold cart items
        let allProducts = []; // Store all products fetched from Firestore
        let currentUserProfile = null; // Store user profile data

        // Filter and Sort states
        let currentSearchQuery = '';
        let currentCategoryFilter = '';
        let currentPriceFilter = '';
        let currentSortOrder = 'featured'; // Default sort order

        // Selected address and phone for checkout
        let selectedAddress = '';
        let selectedPhoneNumber = '';
        let selectedPaymentMethod = ''; // New state for payment method

        // Initialize Firebase and authenticate on page load
        window.onload = async () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Listen for auth state changes to update UI and handle redirects
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("User is signed in:", user.uid);

                        // Check if the user is a buyer
                        const buyerProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                        const buyerDocSnap = await getDoc(buyerProfileRef);

                        if (buyerDocSnap.exists()) {
                            console.log("User is a Buyer. Staying on user-main.html.");
                            currentUserProfile = buyerDocSnap.data(); // Store the profile
                            // Ensure addresses and phoneNumbers are arrays, even if not present in Firestore doc
                            if (!currentUserProfile.addresses) {
                                currentUserProfile.addresses = [];
                            }
                            if (!currentUserProfile.phoneNumbers) {
                                currentUserProfile.phoneNumbers = [];
                            }
                        } else {
                            // Check if the user is a shop owner
                            const shopProfileRef = doc(db, `artifacts/${appId}/shop_users/${user.uid}/profile/data`);
                            const shopDocSnap = await getDoc(shopProfileRef);

                            if (shopDocSnap.exists()) {
                                console.log("User is a Shop Owner. Redirecting to shop-main.html.");
                                window.location.href = 'shop-main.html'; // Redirect to shop owner dashboard
                                return; // Important: exit function after redirect
                            } else {
                                // Authenticated user, but no buyer or shop owner profile found.
                                // This scenario might occur if a user logs in but hasn't completed profile setup.
                                // For now, we'll allow them to browse but won't set currentUserId for profile-dependent features.
                                console.warn("Authenticated user profile not found in 'users' or 'shop_users' collections for UID:", user.uid);
                                currentUserId = null; // Reset currentUserId if no valid profile found
                            }
                        }
                    } else {
                        console.log("No user is signed in. Allowing browsing.");
                        currentUserId = null; // Ensure currentUserId is null if no user
                    }

                    // These functions should always run, regardless of login status,
                    // to display products and load local cart data.
                    fetchFeaturedProducts();
                    loadCartFromLocalStorage();

                    // --- Parse URL parameters on load (moved here to ensure currentUserId is set if logged in) ---
                    const urlParams = new URLSearchParams(window.location.search);
                    const searchQueryParam = urlParams.get('search');
                    const sortQueryParam = urlParams.get('sort'); // This is used for category filtering from landing page

                    if (searchQueryParam) {
                        currentSearchQuery = searchQueryParam.toLowerCase();
                        const searchInput = document.getElementById('search-input');
                        if (searchInput) {
                            searchInput.value = searchQueryParam;
                        }
                    }

                    if (sortQueryParam) {
                        currentCategoryFilter = sortQueryParam;
                        // Update the category dropdown UI
                        const categoryDropdown = document.getElementById('category-dropdown');
                        if (categoryDropdown) {
                            const selectedValueSpan = categoryDropdown.querySelector('.selected-value span');
                            const options = categoryDropdown.querySelectorAll('.dropdown-option');

                            // Remove 'selected' class and checkmark from all options
                            options.forEach(opt => {
                                opt.classList.remove('selected');
                                const checkmark = opt.querySelector('.checkmark');
                                if (checkmark) checkmark.remove();
                            });

                            // Find and select the matching option
                            let found = false;
                            options.forEach(opt => {
                                if (opt.dataset.value === sortQueryParam) {
                                    opt.classList.add('selected');
                                    const checkmarkIcon = document.createElement('i');
                                    checkmarkIcon.classList.add('fas', 'fa-check', 'checkmark');
                                    opt.appendChild(checkmarkIcon);
                                    selectedValueSpan.textContent = opt.textContent.replace('✓', '').trim();
                                    selectedValueSpan.dataset.value = sortQueryParam;
                                    found = true;
                                }
                            });
                            // If the sort parameter doesn't match any specific category, default to "All Categories"
                            if (!found) {
                                currentCategoryFilter = ''; // Reset filter
                                const allCategoriesOption = categoryDropdown.querySelector('.dropdown-option[data-value=""]');
                                if (allCategoriesOption) {
                                    allCategoriesOption.classList.add('selected');
                                    const checkmarkIcon = document.createElement('i');
                                    checkmarkIcon.classList.add('fas', 'fa-check', 'checkmark');
                                    allCategoriesOption.appendChild(checkmarkIcon);
                                    selectedValueSpan.textContent = allCategoriesOption.textContent.replace('✓', '').trim();
                                    selectedValueSpan.dataset.value = '';
                                }
                            }
                        }
                    }
                    // --- END URL Parameter Parsing ---
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // Display a message to the user or log the error more prominently
            }

            // Logout functionality (triggered by clicking the user icon)
            document.getElementById('user-profile-btn').addEventListener('click', () => {
                const logoutBtn = document.getElementById('logout-btn');
                // Only show logout button if a user is actually logged in
                if (auth.currentUser) {
                    logoutBtn.classList.toggle('hidden');
                } else {
                    // If not logged in, clicking the user icon could redirect to login
                    window.location.href = 'login.html';
                }
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    console.log("User signed out successfully.");
                    window.location.href = 'login.html'; // Redirect to login page after logout
                } catch (error) {
                    console.error("Error signing out:", error);
                    // Optionally display an error message to the user
                }
            });

            // Cart sidebar functionality
            document.getElementById('cart-icon-btn').addEventListener('click', () => toggleCartSidebar(null, true)); // Pass true to force open
            document.getElementById('cart-close-btn').addEventListener('click', () => toggleCartSidebar(null, false)); // Pass false to force close
            document.getElementById('overlay').addEventListener('click', () => toggleCartSidebar(null, false)); // Close cart when clicking overlay

            // Add event listener for checkout button to open address/phone modal
            document.getElementById('checkout-button').addEventListener('click', openAddressPhoneModal);

            // Address/Phone Modal Event Listeners
            document.getElementById('cancel-address-phone-modal').addEventListener('click', closeAddressPhoneModal);
            document.getElementById('add-address-btn').addEventListener('click', addNewAddress);
            document.getElementById('add-phone-btn').addEventListener('click', addNewPhoneNumber);
            document.getElementById('confirm-order-btn').addEventListener('click', handleConfirmOrder);

            // Payment method selection listener
            document.getElementById('payment-method-list').addEventListener('change', (event) => {
                if (event.target.name === 'paymentMethod') {
                    selectedPaymentMethod = event.target.value;
                    updateRadioSelection('paymentMethod', selectedPaymentMethod);
                    checkConfirmButtonStatus();
                }
            });

            // My Orders Modal Event Listeners
            document.getElementById('my-orders-btn').addEventListener('click', openMyOrdersModal);
            document.getElementById('close-my-orders-modal').addEventListener('click', closeMyOrdersModal);


            // Geoapify Autocomplete Event Listener for new address input
            const newAddressInput = document.getElementById('new-address-input');
            const autocompleteResultsDiv = document.getElementById('autocomplete-results');

            let autocompleteTimeout;
            newAddressInput.addEventListener('input', () => {
                clearTimeout(autocompleteTimeout);
                const query = newAddressInput.value;
                if (query.length > 2) {
                    autocompleteTimeout = setTimeout(() => fetchAutocompleteSuggestions(query), 300);
                } else {
                    autocompleteResultsDiv.classList.add('hidden');
                    autocompleteResultsDiv.innerHTML = '';
                }
            });

            newAddressInput.addEventListener('focus', () => {
                if (newAddressInput.value.length > 2 && autocompleteResultsDiv.children.length > 0) {
                    autocompleteResultsDiv.classList.remove('hidden');
                }
            });

            newAddressInput.addEventListener('blur', () => {
                // Delay hiding to allow click event on suggestions
                setTimeout(() => {
                    autocompleteResultsDiv.classList.add('hidden');
                }, 100);
            });


            // Initialize custom dropdowns
            setupCustomDropdowns();

            // Search input event listener
            document.getElementById('search-input').addEventListener('input', (event) => {
                currentSearchQuery = event.target.value.toLowerCase();
                applyFiltersAndSort();
            });

            console.log("Page loaded and event listeners attached.");
        };

        // Function to update user display name (simplified for new design)
        async function updateUserNameDisplay(user) {
            // In this new design, we don't display the user's name directly in the navbar
            // but the user icon indicates login status.
            // If you want to show a tooltip or a small pop-up with user info on hover,
            // you would implement that here.
            console.log("User logged in, UI updated for new design.");
        }

        function fetchFeaturedProducts() {
            const productsContainer = document.getElementById('products-container');
            const noItemsMessage = document.getElementById('no-items-message');
            const productCountSpan = document.getElementById('product-count');
            const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/items`);

            onSnapshot(itemsCollectionRef, (snapshot) => {
                allProducts = []; // Clear previous products
                snapshot.forEach((doc) => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });
                applyFiltersAndSort(); // Apply filters and sort after fetching all products
            }, (error) => {
                console.error("Error listening to featured items:", error);
                // Ensure noItemsMessage is handled even on error
                if (noItemsMessage) {
                    noItemsMessage.textContent = "Failed to load products. Please try again later.";
                    noItemsMessage.classList.remove('hidden');
                }
            });
        }

        function applyFiltersAndSort() {
            let filteredProducts = [...allProducts];

            // 1. Apply Search Filter
            if (currentSearchQuery) {
                filteredProducts = filteredProducts.filter(item =>
                    item.itemName.toLowerCase().includes(currentSearchQuery) ||
                    (item.description && item.description.toLowerCase().includes(currentSearchQuery)) ||
                    (item.category && item.category.toLowerCase().includes(currentSearchQuery)) ||
                    (item.location && item.location.toLowerCase().includes(currentSearchQuery)) ||
                    (item.artisan && item.artisan.toLowerCase().includes(currentSearchQuery))
                );
            }

            // 2. Apply Category Filter
            if (currentCategoryFilter) {
                filteredProducts = filteredProducts.filter(item =>
                    item.category && item.category.toLowerCase() === currentCategoryFilter.toLowerCase()
                );
            }

            // 3. Apply Price Filter
            if (currentPriceFilter) {
                const [min, max] = currentPriceFilter.split('-').map(s => parseFloat(s.replace('$', '')));
                filteredProducts = filteredProducts.filter(item => {
                    const price = item.price;
                    if (currentPriceFilter === '101+') {
                        return price > 100;
                    }
                    return price >= min && price <= max;
                });
            }

            // 4. Apply Sort Order
            if (currentSortOrder === 'new-arrivals') {
                filteredProducts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Assuming 'createdAt' field
            } else if (currentSortOrder === 'best-sellers') {
                // This would require a 'salesCount' or similar field in Firestore
                // For now, we'll just sort by rating as a placeholder
                filteredProducts.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else { // Default to 'featured' or no specific sort
                // No specific sort needed for 'featured' if it's just the default display order
            }

            renderProducts(filteredProducts);
        }

        function renderProducts(productsToRender) {
            const productsContainer = document.getElementById('products-container');
            const noItemsMessage = document.getElementById('no-items-message'); // Now a sibling
            const productCountSpan = document.getElementById('product-count');

            if (!productsContainer) {
                console.error("DEBUG: productsContainer is null!");
                return;
            }
            if (!noItemsMessage) {
                console.error("DEBUG: noItemsMessage is null!");
                return;
            }
            if (!productCountSpan) {
                console.error("DEBUG: productCountSpan is null!");
                return;
            }


            productsContainer.innerHTML = ''; // Clear existing items
            productCountSpan.textContent = `${productsToRender.length} products found`;

            if (productsToRender.length === 0) {
                noItemsMessage.classList.remove('hidden');
            } else {
                noItemsMessage.classList.add('hidden');
                productsToRender.forEach(item => {
                    // Determine if 'new' or 'featured' tag should be applied
                    const isNew = item.isNew || false; // Assume a boolean field 'isNew' in Firestore
                    const isFeatured = item.isFeatured || false; // Assume a boolean field 'isFeatured' in Firestore
                    let tagHtml = '';
                    if (isNew) {
                        tagHtml += '<span class="product-tag new">New</span>';
                    } else if (isFeatured) { // If not new, check if featured
                        tagHtml += '<span class="product-tag featured">Featured</span>';
                    }

                    // Placeholder for rating, assuming 'rating' and 'reviewsCount' fields
                    const rating = item.rating || 0;
                    const reviewsCount = item.reviewsCount || 0;
                    let starsHtml = '';
                    for (let i = 0; i < 5; i++) {
                        if (i < Math.floor(rating)) {
                            starsHtml += '<i class="fas fa-star text-yellow-400 text-xs"></i>';
                        } else {
                            starsHtml += '<i class="far fa-star text-gray-300 text-xs"></i>';
                        }
                    }

                    // Assuming item.shopId exists in your Firestore data for products
                    const itemShopId = item.shopId || '';

                    const itemCard = `
                        <div class="product-card relative p-4" data-item-id="${item.id}" data-item-name="${item.itemName}" data-item-price="${item.price}" data-item-image="${item.imageUrl}" data-item-artisan="${item.artisan || 'Unknown Artisan'}" data-item-category="${item.category || ''}" data-item-shop-id="${itemShopId}">
                            ${tagHtml}
                            <img src="${item.imageUrl}" alt="${item.itemName}" class="w-full h-48 object-cover rounded-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/300x200/CCCCCC/000000?text=No+Image';">
                            <div class="text-gray-500 text-xs mb-1"><i class="fas fa-map-marker-alt mr-1"></i>${item.location || 'Vietnam'}</div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">${item.itemName}</h3>
                            <p class="text-gray-700 text-sm mb-2 truncate">${item.description || 'No description provided.'}</p>
                            <div class="flex items-center mb-2">
                                ${starsHtml}
                                <span class="text-xs text-gray-500 ml-2">(${reviewsCount})</span>
                            </div>
                            <div class="flex justify-between items-center mt-3">
                                <span class="text-xl font-bold text-orange-600">$${item.price.toFixed(2)}</span>
                                <button class="add-to-cart-btn bg-orange-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-orange-600 transition-colors">Add to Cart</button>
                            </div>
                        </div>
                    `;
                    productsContainer.insertAdjacentHTML('beforeend', itemCard);
                });

                // Add event listeners to "Add to Cart" buttons
                document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const card = event.target.closest('.product-card');
                        const itemId = card.dataset.itemId;
                        const itemName = card.dataset.itemName;
                        const itemPrice = parseFloat(card.dataset.itemPrice);
                        const itemImage = card.dataset.itemImage;
                        const itemArtisan = card.dataset.itemArtisan;
                        const itemShopId = card.dataset.itemShopId; // Get shopId from data attribute
                        addItemToCart({ id: itemId, name: itemName, price: itemPrice, image: itemImage, artisan: itemArtisan, shopId: itemShopId, quantity: 1 });
                    });
                });
            }
        }

        // Cart Functions
        function loadCartFromLocalStorage() {
            console.log("Attempting to load cart from local storage...");
            const storedCart = localStorage.getItem('craftvietnam_cart');
            if (storedCart) {
                try {
                    cart = JSON.parse(storedCart);
                    console.log("Cart loaded from local storage:", JSON.stringify(cart));
                } catch (e) {
                    console.error("Error parsing cart from local storage, resetting cart:", e);
                    cart = []; // Reset cart if parsing fails
                }
            } else {
                cart = []; // Ensure cart is an empty array if nothing in storage
                console.log("No cart found in local storage. Cart initialized as empty.");
            }
            updateCartUI();
        }

        function saveCartToLocalStorage() {
            console.log("Saving cart to local storage. Current cart:", JSON.stringify(cart));
            localStorage.setItem('craftvietnam_cart', JSON.stringify(cart));
        }

        function addItemToCart(item) {
            console.log("Adding item to cart:", item.name);
            const existingItemIndex = cart.findIndex(cartItem => cartItem.id === item.id);
            if (existingItemIndex > -1) {
                // Item already in cart, increment quantity
                cart[existingItemIndex].quantity += 1;
                console.log(`Incremented quantity for ${item.name}. New quantity: ${cart[existingItemIndex].quantity}`);
            } else {
                // Add new item to cart
                cart.push(item);
                console.log(`Added new item to cart: ${item.name}`);
            }
            saveCartToLocalStorage();
            updateCartUI();
            toggleCartSidebar(null, true); // Open cart sidebar when item is added
        }

        function updateItemQuantity(itemId, change) {
            console.log(`Updating quantity for item ID: ${itemId}, change: ${change}`);
            const itemIndex = cart.findIndex(cartItem => cartItem.id === itemId);
            if (itemIndex > -1) {
                cart[itemIndex].quantity += change;
                if (cart[itemIndex].quantity <= 0) {
                    console.log(`Removing item ${cart[itemIndex].name} as quantity is <= 0.`);
                    cart.splice(itemIndex, 1); // Remove if quantity is 0 or less
                } else {
                    console.log(`New quantity for ${cart[itemIndex].name}: ${cart[itemIndex].quantity}`);
                }
                saveCartToLocalStorage();
                updateCartUI();
            } else {
                console.warn(`Item with ID ${itemId} not found in cart for quantity update.`);
            }
        }

        function removeItemFromCart(itemId) {
            console.log(`Attempting to remove item with ID: ${itemId}`);
            const initialCartLength = cart.length;
            cart = cart.filter(item => item.id !== itemId);
            if (cart.length < initialCartLength) {
                console.log(`Item with ID ${itemId} removed from cart.`);
            } else {
                console.warn(`Item with ID ${itemId} not found in cart for removal.`);
            }
            saveCartToLocalStorage();
            updateCartUI();
        }

        function updateCartUI() {
            try {
                console.log("Updating Cart UI. Current cart state for rendering:", JSON.stringify(cart));
                const cartItemCountSpan = document.getElementById('cart-item-count');
                const cartHeaderItemCountSpan = document.getElementById('cart-header-item-count');
                const cartItemsContainer = document.getElementById('cart-items-container');
                const emptyCartMessage = document.getElementById('empty-cart-message');
                const cartFooter = document.getElementById('cart-footer');
                const cartTotalPriceSpan = document.getElementById('cart-total-price');

                // Debugging null checks
                if (!cartItemCountSpan) console.error("DEBUG: cartItemCountSpan is null!");
                if (!cartHeaderItemCountSpan) console.error("DEBUG: cartHeaderItemCountSpan is null!");
                if (!cartItemsContainer) console.error("DEBUG: cartItemsContainer is null!");
                if (!emptyCartMessage) console.error("DEBUG: emptyCartMessage is null!");
                if (!cartFooter) console.error("DEBUG: cartFooter is null!");
                if (!cartTotalPriceSpan) console.error("DEBUG: cartTotalPriceSpan is null! Element with ID 'cart-total-price' not found.");


                let totalItems = 0;
                let totalPrice = 0;
                cart.forEach(item => {
                    totalItems += item.quantity;
                    totalPrice += item.price * item.quantity;
                });

                // Check if elements exist before attempting to set textContent
                if (cartItemCountSpan) cartItemCountSpan.textContent = totalItems;
                if (cartHeaderItemCountSpan) cartHeaderItemCountSpan.textContent = totalItems;
                if (cartTotalPriceSpan) cartTotalPriceSpan.textContent = `$${totalPrice.toFixed(2)}`;

                // Render cart items
                if (cartItemsContainer) cartItemsContainer.innerHTML = ''; // Clear existing items first
                if (cart.length === 0) {
                    console.log("Cart is empty. Displaying empty cart message.");
                    if (emptyCartMessage) emptyCartMessage.classList.remove('hidden');
                    if (cartFooter) cartFooter.classList.add('hidden');
                } else {
                    console.log(`Cart has ${cart.length} items. Rendering...`);
                    if (emptyCartMessage) emptyCartMessage.classList.add('hidden');
                    if (cartFooter) cartFooter.classList.remove('hidden');
                    cart.forEach(item => {
                        const cartItemDiv = document.createElement('div');
                        cartItemDiv.classList.add('cart-item');
                        cartItemDiv.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="cart-item-image" onerror="this.onerror=null;this.src='https://placehold.co/80x80/CCCCCC/000000?text=No+Image';">
                            <div class="cart-item-details">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-artisan">by ${item.artisan || 'Unknown'}</div>
                                <div class="cart-item-price">$${item.price.toFixed(2)}</div>
                            </div>
                            <div class="cart-item-actions">
                                <button class="quantity-btn decrease-quantity" data-item-id="${item.id}">-</button>
                                <span class="item-quantity">${item.quantity}</span>
                                <button class="quantity-btn increase-quantity" data-item-id="${item.id}">+</button>
                                <button class="cart-item-remove" data-item-id="${item.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        if (cartItemsContainer) cartItemsContainer.appendChild(cartItemDiv);
                    });

                    // Add event listeners to newly created quantity and remove buttons
                    document.querySelectorAll('.decrease-quantity').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const itemId = event.target.closest('.quantity-btn').dataset.itemId;
                            updateItemQuantity(itemId, -1);
                        });
                    });
                    document.querySelectorAll('.increase-quantity').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const itemId = event.target.closest('.quantity-btn').dataset.itemId;
                            updateItemQuantity(itemId, 1);
                        });
                    });
                    document.querySelectorAll('.cart-item-remove').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const itemId = event.target.closest('.cart-item-remove').dataset.itemId;
                            removeItemFromCart(itemId);
                        });
                    });
                }
            } catch (e) {
                console.error("Error in updateCartUI:", e);
                // Potentially display a user-friendly error message here
            }
        }

        // Function to fetch user profile (addresses and phone numbers)
        async function fetchUserProfile(userId) {
            if (!userId) {
                console.error("User ID is null, cannot fetch profile.");
                currentUserProfile = { addresses: [], phoneNumbers: [] }; // Ensure it's initialized even if userId is null
                return;
            }
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                const userProfileSnap = await getDoc(userProfileRef);
                if (userProfileSnap.exists()) {
                    currentUserProfile = userProfileSnap.data();
                    // Ensure addresses and phoneNumbers are arrays, even if not present in Firestore doc
                    if (!currentUserProfile.addresses) {
                        currentUserProfile.addresses = [];
                    }
                    if (!currentUserProfile.phoneNumbers) {
                        currentUserProfile.phoneNumbers = [];
                    }
                    console.log("User profile fetched:", currentUserProfile);
                } else {
                    console.warn("User profile not found for ID:", userId);
                    currentUserProfile = { addresses: [], phoneNumbers: [] }; // Initialize empty if not found
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                currentUserProfile = { addresses: [], phoneNumbers: [] }; // Fallback to empty arrays on error
            }
        }

        // Functions for Address/Phone/Payment Modal
        async function openAddressPhoneModal() {
            if (cart.length === 0) {
                displayMessage("Your cart is empty. Please add items before checking out.", "error");
                return;
            }
            if (!currentUserId) {
                displayMessage("You must be logged in to proceed with checkout.", "error");
                // Optionally, redirect to login page here if you want to force login for checkout
                // window.location.href = 'login.html';
                return;
            }

            // Ensure profile is loaded before opening modal
            await fetchUserProfile(currentUserId);

            const modal = document.getElementById('address-phone-modal');
            modal.classList.add('visible'); // Show modal
            document.body.style.overflow = 'hidden'; // Prevent background scrolling

            renderAddressList();
            renderPhoneNumberList();
            renderPaymentMethodList(); // Render payment options
            checkConfirmButtonStatus(); // Initial check for confirm button
        }

        function closeAddressPhoneModal() {
            const modal = document.getElementById('address-phone-modal');
            modal.classList.remove('visible'); // Hide modal
            document.body.style.overflow = ''; // Re-enable background scrolling
            selectedAddress = ''; // Reset selections
            selectedPhoneNumber = '';
            selectedPaymentMethod = ''; // Reset payment method selection
            // Uncheck all radio buttons in the modal for a clean state
            document.querySelectorAll('#address-phone-modal input[type="radio"]').forEach(radio => {
                radio.checked = false;
                radio.closest('.radio-option')?.classList.remove('selected');
            });
            // Clear new address input and autocomplete results
            document.getElementById('new-address-input').value = '';
            document.getElementById('autocomplete-results').innerHTML = '';
            document.getElementById('autocomplete-results').classList.add('hidden');
        }

        function renderAddressList() {
            const addressListDiv = document.getElementById('address-list');
            addressListDiv.innerHTML = ''; // Clear existing list

            const addresses = currentUserProfile.addresses || [];
            if (addresses.length === 0) {
                addressListDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">No addresses found. Add one below.</p>';
            } else {
                addresses.forEach((address, index) => {
                    const radioOption = document.createElement('label');
                    radioOption.classList.add('radio-option');
                    if (selectedAddress === address) {
                        radioOption.classList.add('selected');
                    }
                    radioOption.innerHTML = `
                        <input type="radio" name="shippingAddress" value="${address}" ${selectedAddress === address ? 'checked' : ''}>
                        <span>${address}</span>
                        <button type="button" class="delete-item-btn" data-item-value="${address}" data-item-type="address">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    radioOption.addEventListener('click', (e) => {
                        // Only update selectedAddress if the radio button itself was clicked, not the delete button
                        if (!e.target.closest('.delete-item-btn')) {
                            selectedAddress = address;
                            updateRadioSelection('shippingAddress', address);
                            checkConfirmButtonStatus();
                        }
                    });
                    addressListDiv.appendChild(radioOption);
                });

                // Add event listeners for delete buttons
                addressListDiv.querySelectorAll('.delete-item-btn[data-item-type="address"]').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const addressToDelete = event.currentTarget.dataset.itemValue;
                        deleteAddress(addressToDelete);
                    });
                });
            }
        }

        function renderPhoneNumberList() {
            const phoneListDiv = document.getElementById('phone-list');
            phoneListDiv.innerHTML = ''; // Clear existing list

            const phoneNumbers = currentUserProfile.phoneNumbers || [];
            if (phoneNumbers.length === 0) {
                phoneListDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">No phone numbers found. Add one below.</p>';
            } else {
                phoneNumbers.forEach((phone, index) => {
                    const radioOption = document.createElement('label');
                    radioOption.classList.add('radio-option');
                    if (selectedPhoneNumber === phone) {
                        radioOption.classList.add('selected');
                    }
                    radioOption.innerHTML = `
                        <input type="radio" name="contactPhone" value="${phone}" ${selectedPhoneNumber === phone ? 'checked' : ''}>
                        <span>${phone}</span>
                        <button type="button" class="delete-item-btn" data-item-value="${phone}" data-item-type="phone">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    radioOption.addEventListener('click', (e) => {
                        // Only update selectedPhoneNumber if the radio button itself was clicked, not the delete button
                        if (!e.target.closest('.delete-item-btn')) {
                            selectedPhoneNumber = phone;
                            updateRadioSelection('contactPhone', phone);
                            checkConfirmButtonStatus();
                        }
                    });
                    phoneListDiv.appendChild(radioOption);
                });

                // Add event listeners for delete buttons
                phoneListDiv.querySelectorAll('.delete-item-btn[data-item-type="phone"]').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const phoneNumberToDelete = event.currentTarget.dataset.itemValue;
                        deletePhoneNumber(phoneNumberToDelete);
                    });
                });
            }
        }

        function renderPaymentMethodList() {
            const paymentMethodListDiv = document.getElementById('payment-method-list');
            // No need to clear innerHTML as the options are static in HTML
            // Just update the selected state based on `selectedPaymentMethod`
            document.querySelectorAll('#payment-method-list input[name="paymentMethod"]').forEach(radio => {
                const label = radio.closest('.radio-option');
                if (radio.value === selectedPaymentMethod) {
                    radio.checked = true;
                    if (label) label.classList.add('selected');
                } else {
                    radio.checked = false;
                    if (label) label.classList.remove('selected');
                }
            });
        }

        function updateRadioSelection(name, value) {
            document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                const label = radio.closest('.radio-option');
                if (radio.value === value) {
                    radio.checked = true;
                    if (label) label.classList.add('selected');
                } else {
                    radio.checked = false;
                    if (label) label.classList.remove('selected');
                }
            });
        }

        async function addNewAddress() {
            const newAddressInput = document.getElementById('new-address-input');
            const address = newAddressInput.value.trim();
            if (address && currentUserId) {
                try {
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                    await updateDoc(userProfileRef, {
                        addresses: arrayUnion(address)
                    });
                    // After successful update, update local state and re-render
                    if (!currentUserProfile.addresses) { // Defensive check
                        currentUserProfile.addresses = [];
                    }
                    currentUserProfile.addresses.push(address); // Update local state
                    selectedAddress = address; // Select the newly added address
                    renderAddressList();
                    newAddressInput.value = ''; // Clear input
                    document.getElementById('autocomplete-results').innerHTML = ''; // Clear autocomplete results
                    document.getElementById('autocomplete-results').classList.add('hidden');
                    displayMessage("Address added successfully!", "success");
                    checkConfirmButtonStatus();
                } catch (error) {
                    console.error("Error adding new address:", error);
                    displayMessage("Failed to add address. Please try again.", "error");
                }
            } else {
                displayMessage("Please enter a valid address.", "error");
            }
        }

        async function deleteAddress(addressToDelete) {
            if (!currentUserId) {
                displayMessage("You must be logged in to delete an address.", "error");
                return;
            }
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await updateDoc(userProfileRef, {
                    addresses: arrayRemove(addressToDelete)
                });
                // Update local state and re-render
                currentUserProfile.addresses = currentUserProfile.addresses.filter(addr => addr !== addressToDelete);
                if (selectedAddress === addressToDelete) {
                    selectedAddress = ''; // Deselect if the deleted address was selected
                }
                renderAddressList();
                displayMessage("Address deleted successfully!", "success");
                checkConfirmButtonStatus();
            } catch (error) {
                console.error("Error deleting address:", error);
                displayMessage("Failed to delete address. Please try again.", "error");
            }
        }

        async function addNewPhoneNumber() {
            const newPhoneInput = document.getElementById('new-phone-input');
            const phoneNumber = newPhoneInput.value.trim();
            if (phoneNumber && currentUserId) {
                try {
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                    await updateDoc(userProfileRef, {
                        phoneNumbers: arrayUnion(phoneNumber)
                    });
                    // After successful update, update local state and re-render
                    if (!currentUserProfile.phoneNumbers) { // Defensive check
                        currentUserProfile.phoneNumbers = [];
                    }
                    currentUserProfile.phoneNumbers.push(phoneNumber); // Update local state
                    selectedPhoneNumber = phoneNumber; // Select the newly added phone
                    renderPhoneNumberList();
                    newPhoneInput.value = ''; // Clear input
                    displayMessage("Phone number added successfully!", "success");
                    checkConfirmButtonStatus();
                } catch (error) {
                    console.error("Error adding new phone number:", error);
                    displayMessage("Failed to add phone number. Please try again.", "error");
                }
            } else {
                displayMessage("Please enter a valid phone number.", "error");
            }
        }

        async function deletePhoneNumber(phoneNumberToDelete) {
            if (!currentUserId) {
                displayMessage("You must be logged in to delete a phone number.", "error");
                return;
            }
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await updateDoc(userProfileRef, {
                    phoneNumbers: arrayRemove(phoneNumberToDelete)
                });
                // Update local state and re-render
                currentUserProfile.phoneNumbers = currentUserProfile.phoneNumbers.filter(phone => phone !== phoneNumberToDelete);
                if (selectedPhoneNumber === phoneNumberToDelete) {
                    selectedPhoneNumber = ''; // Deselect if the deleted phone number was selected
                }
                renderPhoneNumberList();
                displayMessage("Phone number deleted successfully!", "success");
                checkConfirmButtonStatus();
            } catch (error) {
                console.error("Error deleting phone number:", error);
                displayMessage("Failed to delete phone number. Please try again.", "error");
            }
        }

        function checkConfirmButtonStatus() {
            const confirmButton = document.getElementById('confirm-order-btn');
            if (selectedAddress && selectedPhoneNumber && selectedPaymentMethod) { // All three must be selected
                confirmButton.removeAttribute('disabled');
            } else {
                confirmButton.setAttribute('disabled', 'true');
            }
        }

        async function handleConfirmOrder() {
            if (!selectedAddress || !selectedPhoneNumber || !selectedPaymentMethod) {
                displayMessage("Please select a shipping address, a phone number, and a payment method.", "error");
                return;
            }
            // Proceed with placing the order using selectedAddress and selectedPhoneNumber
            await placeOrder(selectedAddress, selectedPhoneNumber, selectedPaymentMethod);
            closeAddressPhoneModal(); // Close modal after order is placed
        }

        async function placeOrder(shippingAddress, buyerPhoneNumber, paymentMethod) {
            console.log("Attempting to place order with selected details...");

            if (cart.length === 0) {
                displayMessage("Your cart is empty. Please add items before checking out.", "error");
                return;
            }

            if (!currentUserId) {
                displayMessage("You must be logged in to place an order.", "error");
                return;
            }

            try {
                let buyerName = currentUserProfile.name || 'Guest';
                let buyerEmail = currentUserProfile.email || 'N/A';

                const orderId = Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9);
                let totalOrderPrice = 0;
                const orderItems = cart.map(item => {
                    totalOrderPrice += item.price * item.quantity;
                    return {
                        itemId: item.id,
                        itemName: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        imageUrl: item.image,
                        artisan: item.artisan || 'Unknown',
                        shopId: item.shopId || 'Unknown Shop'
                    };
                });

                const orderData = {
                    orderId: orderId,
                    userId: currentUserId,
                    buyerName: buyerName,
                    buyerEmail: buyerEmail,
                    shippingAddress: shippingAddress,
                    buyerPhoneNumber: buyerPhoneNumber,
                    paymentMethod: paymentMethod,
                    items: orderItems,
                    totalPrice: totalOrderPrice,
                    orderDate: new Date().toISOString(),
                    status: 'pending' // Initial status
                };

                // Store orders in user-specific collection
                const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/orders`);
                await addDoc(ordersCollectionRef, orderData);

                console.log("Order placed successfully:", orderData);
                displayMessage("Order placed successfully! Thank you for your purchase.", "success");

                cart = [];
                saveCartToLocalStorage();
                updateCartUI();

            } catch (error) {
                console.error("Error placing order:", error);
                displayMessage(`Failed to place order: ${error.message}`, "error");
            }
        }

        function displayMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            const messageBoxText = document.getElementById('message-box-text');
            const messageBoxCloseBtn = document.getElementById('message-box-close');

            if (!messageBox || !messageBoxText || !messageBoxCloseBtn) {
                console.error("Message box elements not found!");
                return;
            }

            messageBoxText.textContent = message;
            messageBoxText.className = `text-lg font-semibold mb-4 ${type === 'success' ? 'text-green-700' : 'text-red-700'}`;
            messageBox.classList.add('visible'); // Use 'visible' class for showing

            // Remove existing event listener to prevent multiple calls
            const oldCloseBtn = messageBoxCloseBtn.cloneNode(true);
            messageBoxCloseBtn.parentNode.replaceChild(oldCloseBtn, messageBoxCloseBtn);

            document.getElementById('message-box-close').addEventListener('click', () => {
                messageBox.classList.remove('visible'); // Use 'visible' class for hiding
            });
        }

        function toggleCartSidebar(event, forceOpen = null) {
            const cartSidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('overlay');
            const body = document.body;

            let isOpen = cartSidebar.classList.contains('open');

            if (forceOpen === true && !isOpen) {
                cartSidebar.classList.add('open');
                overlay.classList.add('active');
                overlay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
                body.style.overflow = 'hidden'; // Prevent scrolling when cart is open
                console.log("Cart opened.");
            } else if (forceOpen === false && isOpen) {
                cartSidebar.classList.remove('open');
                overlay.style.backgroundColor = "rgba(0, 0, 0, 0)";
                overlay.classList.remove('active');
                body.style.overflow = ''; // Re-enable scrolling
                console.log("Cart closed.");
            } else if (forceOpen === null) { // Toggle behavior
                if (isOpen) {
                    cartSidebar.classList.remove('open');
                    overlay.style.backgroundColor = "rgba(0, 0, 0, 0)";
                    overlay.classList.remove('active');
                    body.style.overflow = '';
                    console.log("Cart toggled closed.");
                } else {
                    cartSidebar.classList.add('open');
                    overlay.classList.add('active');
                    overlay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
                    body.style.overflow = 'hidden';
                    console.log("Cart toggled open.");
                }
            }
        }

        // Custom Dropdown Logic
        function setupCustomDropdowns() {
            document.querySelectorAll('.custom-dropdown-container').forEach(container => {
                const selectedValueDiv = container.querySelector('.selected-value');
                const optionsDiv = container.querySelector('.dropdown-options');
                const options = optionsDiv.querySelectorAll('.dropdown-option');

                selectedValueDiv.addEventListener('click', () => {
                    // Close other open dropdowns
                    document.querySelectorAll('.dropdown-options.open').forEach(openOptions => {
                        if (openOptions !== optionsDiv) {
                            openOptions.classList.remove('open');
                        }
                    });
                    optionsDiv.classList.toggle('open');
                });

                options.forEach(option => {
                    option.addEventListener('click', () => {
                        // Remove 'selected' class from all options in this dropdown
                        options.forEach(opt => opt.classList.remove('selected'));
                        // Add 'selected' class to the clicked option
                        option.classList.add('selected');

                        // Update the displayed value
                        selectedValueDiv.querySelector('span').textContent = option.textContent.replace('✓', '').trim();
                        selectedValueDiv.querySelector('span').dataset.value = option.dataset.value;

                        // Add/remove checkmark
                        options.forEach(opt => {
                            const checkmark = opt.querySelector('.checkmark');
                            if (checkmark) checkmark.remove();
                        });
                        const checkmarkIcon = document.createElement('i');
                        checkmarkIcon.classList.add('fas', 'fa-check', 'checkmark');
                        option.appendChild(checkmarkIcon);

                        optionsDiv.classList.remove('open'); // Close dropdown after selection

                        // Trigger filter/sort based on which dropdown was clicked
                        if (container.id === 'category-dropdown') {
                            currentCategoryFilter = option.dataset.value;
                        } else if (container.id === 'price-dropdown') {
                            currentPriceFilter = option.dataset.value;
                        } else if (container.id === 'sort-dropdown') {
                            currentSortOrder = option.dataset.value;
                        }
                        applyFiltersAndSort(); // Re-apply filters and sort
                    });
                });

                // Close dropdown if clicked outside
                document.addEventListener('click', (event) => {
                    if (!container.contains(event.target)) {
                        optionsDiv.classList.remove('open');
                    }
                });
            });
        }

        // Geoapify Autocomplete Function
        async function fetchAutocompleteSuggestions(query) {
            const autocompleteResultsDiv = document.getElementById('autocomplete-results');
            autocompleteResultsDiv.innerHTML = ''; // Clear previous results

            try {
                const response = await fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&apiKey=${GEOAPIFY_API_KEY}`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    data.features.forEach(feature => {
                        const item = document.createElement('div');
                        item.classList.add('autocomplete-item');
                        item.textContent = feature.properties.formatted;
                        item.addEventListener('mousedown', (e) => { // Use mousedown to prevent blur event from hiding results too soon
                            e.preventDefault(); // Prevent input from losing focus immediately
                            document.getElementById('new-address-input').value = feature.properties.formatted;
                            autocompleteResultsDiv.classList.add('hidden');
                        });
                        autocompleteResultsDiv.appendChild(item);
                    });
                    autocompleteResultsDiv.classList.remove('hidden');
                } else {
                    autocompleteResultsDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching autocomplete suggestions:", error);
                autocompleteResultsDiv.classList.add('hidden');
            }
        }

        // My Orders Functions
        async function openMyOrdersModal() {
            if (!currentUserId) {
                displayMessage("You must be logged in to view your orders.", "error");
                return;
            }

            const modal = document.getElementById('my-orders-modal');
            modal.classList.add('visible'); // Show modal
            document.body.style.overflow = 'hidden'; // Prevent background scrolling

            fetchBuyerOrders(); // Fetch and render orders when modal opens
        }

        function closeMyOrdersModal() {
            const modal = document.getElementById('my-orders-modal');
            modal.classList.remove('visible'); // Hide modal
            document.body.style.overflow = ''; // Re-enable background scrolling
        }

        function fetchBuyerOrders() {
            if (!currentUserId) {
                console.error("Cannot fetch orders: currentUserId is null.");
                return;
            }

            const ordersListDiv = document.getElementById('orders-list');
            ordersListDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">Loading orders...</p>'; // Loading message

            const userOrdersCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/orders`);
            const q = query(userOrdersCollectionRef); // No need for where clause as it's already user-specific

            onSnapshot(q, (snapshot) => {
                const orders = [];
                snapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                // Sort orders by date, newest first
                orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                renderOrdersList(orders);
            }, (error) => {
                console.error("Error fetching buyer orders:", error);
                ordersListDiv.innerHTML = '<p class="text-red-500 text-sm text-center py-2">Failed to load orders. Please try again.</p>';
            });
        }

        function renderOrdersList(orders) {
            const ordersListDiv = document.getElementById('orders-list');
            ordersListDiv.innerHTML = ''; // Clear existing list

            if (orders.length === 0) {
                ordersListDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">No orders found.</p>';
            } else {
                orders.forEach(order => {
                    const orderDate = new Date(order.orderDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const orderTime = new Date(order.orderDate).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const statusClass = `status-${order.status.toLowerCase().replace(/\s/g, '-')}`;

                    const orderCard = document.createElement('div');
                    orderCard.classList.add('order-card');
                    orderCard.innerHTML = `
                        <div class="order-summary">
                            <div>
                                <div class="text-sm text-gray-500">Order ID: <span class="font-normal">${order.orderId.substring(0, 8)}...</span></div>
                                <div class="text-base">Total: <span class="text-orange-600">$${order.totalPrice.toFixed(2)}</span></div>
                                <div class="text-xs text-gray-500">${orderDate} at ${orderTime}</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="status-badge ${statusClass}">${order.status}</span>
                                <i class="fas fa-chevron-down text-gray-500 transition-transform duration-300"></i>
                            </div>
                        </div>
                        <div class="order-details-container mt-4">
                            <h5 class="font-medium text-gray-700 mb-2">Items:</h5>
                            <div class="space-y-2">
                                ${order.items.map(item => `
                                    <div class="order-item-detail">
                                        <img src="${item.imageUrl}" alt="${item.itemName}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/CCCCCC/000000?text=No+Image';" />
                                        <div class="order-item-info">
                                            <div class="item-name">${item.itemName}</div>
                                            <div class="text-xs text-gray-500">by ${item.artisan}</div>
                                            <div class="item-price">$${item.price.toFixed(2)} x ${item.quantity}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-4 text-sm text-gray-700">
                                <strong>Shipping Address:</strong> ${order.shippingAddress}<br>
                                <strong>Phone Number:</strong> ${order.buyerPhoneNumber}<br>
                                <strong>Payment Method:</strong> ${order.paymentMethod}
                            </div>
                        </div>
                    `;
                    ordersListDiv.appendChild(orderCard);

                    // Add click listener to toggle details
                    orderCard.querySelector('.order-summary').addEventListener('click', () => {
                        const detailsContainer = orderCard.querySelector('.order-details-container');
                        const chevronIcon = orderCard.querySelector('.fa-chevron-down');
                        detailsContainer.classList.toggle('open');
                        chevronIcon.classList.toggle('rotate-180'); // Rotate icon on open/close
                    });
                });
            }
        }
    </script>
</body>
</html>
